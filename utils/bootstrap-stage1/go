#!/bin/bash

# should set toplevel via autoconf?
toplevel=$PWD/../..

# source our common variables and functions
. $toplevel/utils/bootstrap-early/functions


build()
{
    # FIXME: CLFS book says CFLAGS and CXXFLAGS NEED to be unset
    #        during cross stage, but it writes the unset commands into
    #        .bashrc, which is still in use in later stages prior to
    #        booting/chrooting into the baby system...  Do we need to
    #        unset them here?
    unset CFLAGS
    unset CXXFLAGS
    unset CPPFLAGS
    unset LDFLAGS

    # set some common variables for all targets
    #
    # NOTE: We don't need any conditionals here because all supported build
    #       types use CLFS_TARGET for --host throughout the stage1 bootstrap.
    OPTS="--prefix=$PREFIX_FINAL"
    OPTS+=" --build=${CLFS_HOST}"
    OPTS+=" --host=${CLFS_TARGET}"

    # put libs in lib64 if we're building x86_64 multilib
    if [ -n "$BUILD32" ]; then
	OPTS+=" --libdir=$PREFIX_FINAL/lib64"
    fi

    OPTS+=" --disable-static"
    OPTS+=" --enable-shared"
    OPTS+=" --disable-nls"

    set_cross_compile

    case "$1" in
	gmp)
	    HOST_CC=gcc \
		build_generic $1 $OPTS \
		--enable-cxx || exit 1
	    ;;

	isl)
	    build_generic $1 $OPTS \
		--with-gmp-prefix=$PREFIX_FINAL || exit 1
	    ;;

        cloog)
	    build_generic $1 $OPTS \
		--with-gmp-prefix=$PREFIX_FINAL \
		--with-isl-prefix=$PREFIX_FINAL || exit 1
            ;;

	zlib)
	    # NOTE: zlib doesn't use autotools... despite the "configure"
	    #       script and autotool-ish configure flags.  This means it
	    #       doesn't support out-of-tree builds, and its build system
	    #       usage is just different enough to break our
	    #       configure_generic routine...
	    #
	    # FIXME: i think zlib is using CMake, which we should
	    #        perhaps build support for into our generic build
	    #        scripts... although, the real problem here is
	    #        configure failing if passed any invalid args...
	    build_in_tree=yes setup_generic $1 || exit 1

	    # NOTE: It also fails to configure if any unknown flags are passed
	    #       in, so we can't use our generic OPTS variable...
	    OPTS="--prefix=$PREFIX_FINAL"

	    if [ -n "$BUILD32" ]; then
		OPTS+=" --libdir=$PREFIX_FINAL/lib64"
	    fi

	    pushd $builddir &&
	    ./configure $OPTS &&
	    popd || exit 1

	    compile_generic $1 || exit 1
	    ;;

	binutils)
	    # FIXME: CLFS 20130924 has a sed statement to fix build problems
	    #        on host systems w/ texinfo 5.x.  My boxes hav 4.x, so I
	    #        don't need it for now, but we should add this check to
	    #        configure.  Either add the sed statement here
	    #        universally and conditionally build texinfo 5.x in
	    #        bootstrap-early or have the configure script enable the
	    #        sed statement only if host system has texinfo 5.x.
	    #        Whichever is easier.
            #
            # FIXME: If we do it, don't forget to un-sed at the end as we might
            #        be building in-tree or referencing a git checkout...
	    #
	    # sed -i -e 's/@colophon/@@colophon/' \
	    #     -e 's/doc@cygnus.com/doc@@cygnus.com/' bfd/doc/bfd.texinfo

            # add 64bit support if desired
            if [ -n "$BUILD64" ]; then
                OPTS+=" --enable-64-bit-bfd"
            fi
            # disable multilib if we're building pure 32 or 64 bit
            if [ -z "$BUILD32" ]; then
                OPTS+=" --disable-multilib"
                OPTS+=" --with-lib-path=$PREFIX_FINAL/lib"
            else
                OPTS+=" --with-lib-path=$PREFIX_FINAL/lib64:$PREFIX_FINAL/lib"
            fi

	    setup_generic $1 &&
	    configure_generic $1 $OPTS \
                --target=${CLFS_TARGET} || exit 1

	    pushd $builddir &&
	    make configure-host &&
	    make -j$JOBCOUNT &&
	    make install &&
	    popd || exit 1
	    ;;

	gcc)
	    setup_generic gcc || exit 1

            # apply the CLFS specs patch
	    if [ ! -f $builddir/Makefile ]; then
                # NOTE: gcc has a different patch for pure64 than for x86 or
                #       x86_64 multilib.
                if [ -n "$BUILD64" -a -z "$BUILD32" ]; then
                    p=$toplevel/utils/bootstrap-cross/patches/gcc/*-pure64_specs-*.patch
                else
                    p=$toplevel/utils/bootstrap-cross/patches/gcc/*-specs-*.patch
                fi
		pushd $source &&
		patch -Np1 < $p || exit 1
		popd
	    fi

	    # make GCC look in PREFIX_FINAL (i.e., not the host sys)
            #
            # FIXME: This is only ok because we use a dist tarball for gcc's
            #        sources... if we ever swtich to a git tree, we'll need to
            #        either make a copy of the source tree or undo this at the
            #        end...
            pushd $source
	    echo "#undef STANDARD_STARTFILE_PREFIX_1" >> gcc/config/linux.h
            echo "#define STANDARD_STARTFILE_PREFIX_1 \"$PREFIX_FINAL/lib/\"" >> gcc/config/linux.h
	    echo "#undef STANDARD_STARTFILE_PREFIX_2" >> gcc/config/linux.h
            echo "#define STANDARD_STARTFILE_PREFIX_2 \"\"" >> gcc/config/linux.h
            popd

            # Apply a sed subsitution that will suppress the execution
            # of the fixincludes script:
            #
            # FIXME: same here, we could need to undo this
            pushd $source &&
            cp -v gcc/Makefile.in{,.orig} &&
            sed 's@\./fixinc\.sh@-c true@' gcc/Makefile.in.orig > gcc/Makefile.in &&
            popd || exit 1

            # extra tweaks
            if [ -n "$BUILD32" ]; then
                # x86_64 multilib
                OPTS+=" --libexecdir=$PREFIX_FINAL/lib64"
            else
                # x86_64 pure or x86
                OPTS+=" --disable-multilib"
            fi

            configure_generic $1 $OPTS \
                --target=${CLFS_TARGET} \
                --with-local-prefix=$PREFIX_FINAL \
                --enable-long-long --enable-c99 --enable-shared --enable-threads=posix \
                --disable-nls --enable-__cxa_atexit --enable-languages=c,c++ \
                --disable-libstdcxx-pch --enable-cloog-backend=isl --with-gmp=$PREFIX_FINAL \
                --with-mpfr=$PREFIX_FINAL --with-mpc=$PREFIX_FINAL --with-isl=$PREFIX_FINAL \
                --disable-isl-version-check --with-cloog=$PREFIX_FINAL --with-system-zlib \
                --with-native-system-header-dir=$PREFIX_FINAL/include --disable-libssp \
                --disable-install-libiberty  --enable-libstdcxx-time \
                --enable-checking=release || exit 1

	    pushd $builddir || exit 1
	    #  The following will prevent GCC from looking in the wrong
	    #  directories for headers and libraries
            cp -v Makefile{,.orig} &&
            sed "/^HOST_\(GMP\|ISL\|CLOOG\)\(LIBS\|INC\)/s:$PREFIX_FINAL:$PREFIX_CROSS:g" \
                Makefile.orig > Makefile || exit 1

	    make -j$JOBCOUNT AS_FOR_TARGET="${AS}" LD_FOR_TARGET="${LD}" &&
	    make install &&
	    popd || exit 1
	    ;;

	ncurses)
            # FIXME: There is also a CLFS patch to fix some bash-related
            #        problems, but I haven't run into the bug it fixes, so I've
            #        left it out for now.
	    build_generic $1 $OPTS \
                --without-debug --without-ada \
                --enable-overwrite --with-build-cc=gcc || exit 1
		;;

	busybox)
	    setup_generic $1 || exit 1

	    # get ready
	    MAKE="make KBUILD_SRC=$source -f $source/Makefile"
	    MAKE+=" ARCH=$CLFS_ARCH CROSS_COMPILE=$CLFS_TARGET-"
	    pushd $builddir &&
	    $MAKE mrproper &&
	    popd || exit 1

	    # create .config
	    #
	    # NOTE: We're planning on using the busybox variants of everything
	    #       possible.  Any exceptions will be noted.
	    #
	    # NOTE: if you want to do a make menuconfig to tweak .config,
	    #       NCURSES_PREFIX has to be set to $PREFIX_FINAL in order
	    #       to use the ncurses installed via bootstrap-early (and
	    #       our KBUILD patch needs to be applied)
            cp -v config/bb-config $builddir/.config &&
	    pushd $builddir &&
	    $MAKE oldconfig &&
            popd || exit 1

	    # build
	    #
	    # FIXME: current embedded CLFS book doesn't set ARCH here, but
	    #        it does have a config patch...
            pushd $builddir &&
	    $MAKE -j$JOBCOUNT_KBUILD &&
	    popd || exit 1

	    # install
            pushd $builddir &&
	    $MAKE CONFIG_PREFIX=$PREFIX_FINAL install &&
            popd || exit 1

	    # NOTE: busybox binary is setuid root later on under
	    #       fix-perms

	    # FIXME: there are a bunch of config files in
	    #        $source/examples that we might want installed too
	    #cp $source/examples/depmod.pl $PREFIX_FINAL/bin &&
	    #chmod 755 $PREFIX_FINAL/bin/depmod.pl|| exit 1

	    ;;

        bison)
            setup_generic $1 || exit 1

            # Apply a sed which disables the building of bison.help
            # when cross-compiling.
            #
            # NOTE: In $source!  This means we either have to undo
            #       this at the end or make a copy of the source tree
            #       (because bison is a git submodule in src/)
            pushd $source &&
            [ -f Makefile.in.orig ] && exit 1
            cp -v Makefile.in{,.orig} &&
            sed '/bison.help:/s/^/# /' Makefile.in.orig > Makefile.in &&
            popd || exit 1

            # The configure script does not determine the correct
            # value for the following. Set the value manually:
            #
            # NOTE: In $builddir!!!
            pushd $builddir
            echo "ac_cv_prog_lex_is_flex=yes" > config.cache
            popd

            M4=m4 configure_generic $1 $OPTS \
                --cache-file=config.cache &&
            compile_generic $1 || exit 1

            # revert the Makefile.in changes
            pushd $source &&
            mv Makefile.in{.orig,} &&
            popd || exit 1
            ;;

	flex)
	    setup_generic $1 || exit 1

	    # When cross-compiling, the configure script does not determine
	    # the correct values for the following, so we'll set the values
	    # manually
	    pushd $builddir &&
	    echo ac_cv_func_malloc_0_nonnull=yes > config.cache &&
	    echo ac_cv_func_realloc_0_nonnull=yes >> config.cache &&
	    popd || exit 1

            M4=m4 configure_generic $1 $OPTS \
		--cache-file=config.cache || exit 1

            # NOTE: We can't let flex build manpage, because help2man tries to
            #       run ../flex --help, which is cross-compiled for a
            #       non-native architecture.  The following sed statements
            #       disable manpage and pdf generation for now.
            #
            # NOTE: CLFS doesn't run into this because they use dist tarballs
            #       as apposed to git trees.
	    #
	    # FIXME: I think?  I'm not entirely sure why the behavior isn't
	    #        more consistent accross host systems... definately
	    #        barfs on avlinux, but even when "cross-compiling" for
	    #        i686 on an i686.  And I swear I got past this w/out any
	    #        issues on a really old 32bit fedora box...
            pushd $builddir &&
            sed -i 's|^dist_man_MANS|#dist_man_MANS|' doc/Makefile &&
            sed -i 's|^dist_doc_DATA|#dist_doc_DATA|' doc/Makefile &&
            popd || exit 1

	    compile_generic $1 || exit 1
	    ;;

	gettext)
	    setup_generic $1 || exit

	    # Only the programs in the gettext-tools directory need to be
	    # installed for the temp-system
	    source=$source/gettext-tools
	    configure=$source/configure
	    echo source: $source
	    echo configure: $configure

	    # When cross-compiling the Gettext configure script assumes we
	    # don't have a working wcwidth when we do. The following will
	    # fix possible compilation errors because of this assumption
	    pushd $builddir &&
	    echo "gl_cv_func_wcwidth_works=yes" > config.cache &&
	    popd || exit 1

	    # FIXME: We've got --enable-shared --disable-static in
	    #        $OPTS... Does disabling shard now re-enable static?
	    configure_generic $1 $OPTS \
		--disable-shared \
		--cache-file=config.cache || exit 1

	    pushd $builddir &&
	    make -j$JOBCOUNT -C gnulib-lib &&
	    make -j$JOBCOUNT -C src msgfmt &&
	    cp -v src/msgfmt $PREFIX_FINAL/bin &&
	    popd || exit 1
	    ;;

	m4)
	    setup_generic $1 || exit 1

	    # Configure can not properly determine the results of the
	    # following tests
	    pushd $builddir &&
	    echo gl_cv_func_btowc_eof=yes > config.cache &&
	    echo gl_cv_func_mbrtowc_incomplete_state=yes >> config.cache &&
	    echo gl_cv_func_mbrtowc_sanitycheck=yes >> config.cache &&
	    echo gl_cv_func_mbrtowc_null_arg=yes >> config.cache &&
	    echo gl_cv_func_mbrtowc_retval=yes >> config.cache &&
	    echo gl_cv_func_mbrtowc_nul_retval=yes >> config.cache &&
	    echo gl_cv_func_wcrtomb_retval=yes >> config.cache &&
	    echo gl_cv_func_wctob_works=yes >> config.cache &&
	    popd || exit 1

	    configure_generic $1 $OPTS \
		--cache-file=config.cache &&
	    compile_generic || exit 1
	    ;;

	make)
	    build_generic $1 $OPTS --without-guile || exit 1
	    ;;

	texinfo)
	    # We have a configure.ac patch and need to force an autoreconf
	    autoreconf=yes \
		setup_generic $1 || exit 1

	    # We need to set LDFLAGS like this so that texinfo's build can
	    # find our bootstrap-early stuff (ncurses, specifically).
	    LDFLAGS=-L$PREFIX_EARLY/lib \
		configure_generic $1 $OPTS || exit 1

	    pushd $builddir &&
	    make -j$JOBCOUNT -C tools/gnulib/lib &&
	    make -j$JOBCOUNT -C tools &&
	    make -j$JOBCOUNT &&
	    make install &&
	    popd || exit 1
	    ;;

	create-dirs)
	    mkdir -pv ${CLFS}/{bin,boot,dev,{etc/,}opt,home,lib,mnt}
	    mkdir -pv ${CLFS}/{proc,media/{floppy,cdrom},run/{,shm},sbin,srv,sys}
	    mkdir -pv ${CLFS}/var/{lock,log,mail,spool}
	    mkdir -pv ${CLFS}/var/{opt,cache,lib/{misc,locate},local}
	    install -dv ${CLFS}/root -m 0750
	    install -dv ${CLFS}{/var,}/tmp -m 1777
	    mkdir -pv ${CLFS}/usr/{,local/}{bin,include,lib,sbin,src}
	    mkdir -pv ${CLFS}/usr/{,local/}share/{doc,info,locale,man}
	    mkdir -pv ${CLFS}/usr/{,local/}share/{misc,terminfo,zoneinfo}
	    mkdir -pv ${CLFS}/usr/{,local/}share/man/man{1,2,3,4,5,6,7,8}
	    for dir in ${CLFS}/usr{,/local}; do
		ln -sv share/{man,doc,info} $dir
	    done

	    if [ -n "$BUILD32" ]; then
		# multilib dirs
		mkdir -pv ${CLFS}/lib64
		mkdir -pv ${CLFS}/var/lib64/{misc,locate}
		mkdir -pv ${CLFS}/usr/{,local/}lib64
		install -dv ${CLFS}/usr/lib/locale
		ln -sv ../lib/locale ${CLFS}/usr/lib64
	    fi

	    # I like these too much to leave out...
	    mkdir -pv $CLFS/mnt/{cdrom,flash,floppy,crypt}

	    echo done
	    ;;

	create-symlinks)

            # FIXME: take the 2>/dev/null off all these lines to more closely
            #        match CLFS, unless there was a really good reason I added
            #        them...
            #
            # FIXME: This freshly copy-n-pasted (and then variable substituted)
            #        block of ln commands from 20130924 differs from what I had
            #        before:
            #
            #        1. It no longer creates /bin/{mount,umount} or
            #           /sbin/{swapon,swapoff}.
            #
            #        2. It now creates /bin/{login,passwd},
            #           /sbin/{agetty,blkid}, and /var/run.

	    ln -sv $PREFIX_FINAL/bin/{bash,cat,echo,grep,login,passwd,pwd,sleep,stty} ${CLFS}/bin 2>/dev/null
	    ln -sv $PREFIX_FINAL/bin/file ${CLFS}/usr/bin 2>/dev/null
	    ln -sv $PREFIX_FINAL/sbin/{agetty,blkid} ${CLFS}/sbin 2>/dev/null
	    ln -sv $PREFIX_FINAL/lib/libgcc_s.so{,.1} ${CLFS}/usr/lib 2>/dev/null

	    ln -sv $PREFIX_FINAL/lib/libstd*so* ${CLFS}/usr/lib 2>/dev/null

	    ln -sv ../run ${CLFS}/var/run

	    if [ -n "$BUILD32" ]; then
		# x86_64 multilib only
		ln -sv $PREFIX_FINAL/lib64/libgcc_s.so{,.1} ${CLFS}/usr/lib64 2>/dev/null
		ln -sv $PREFIX_FINAL/lib64/libstd*so* ${CLFS}/usr/lib64 2>/dev/null

	    elif [ -n "$BUILD64" ]; then
		# x86_64 pure only

		# To enable some c++ tests in the Glibc and Binutils testsuites
		# to link, create a directory and make some symbolic links:
		mkdir -pv ${CLFS}/usr/lib64
		ln -sv $PREFIX_FINAL/lib/libstd*so* ${CLFS}/usr/lib64 2>/dev/null

	    fi

	    # CLFS used bash for this one, but we're using busybox's ash
	    # instead.  in case we change this later, we just symlink our
	    # bootstrap sh symlink to our baby system's /bin/sh
            #
            # FIXME: should this point at ash or sh?
	    ln -sv $PREFIX_FINAL/bin/sh ${CLFS}/bin/sh 2>/dev/null

            # remove the broken bash symlink created by the copy-n-pasted CLFS
            # scriptlet above.
            #
            # FIXME: instead of removing, should i make this point as ash?
            #
            # FIXME: actually, the new version of busybox installs it's own
            #        /bin/bash symlink down below.
	    rm -f $CLFS/bin/bash

            # remove the broken agetty symlink created by the copy-n-pasted
            # CLFS scriptlet above.
            rm -f $CLFS/sbin/agetty

	    # we've got some more symlinks to make, because we use our
	    # boostrap busybox install in place of a bunch of extra packages
	    # that CLFS installs directly in the baby system.  the easiest
	    # thing to do here, is just make symlinks to all the busybox
	    # symlinks in the baby system by parsing busybox.links in
	    # busybox's builddir
	    for x in $(cat .build/busybox/busybox.links || exit 1); do
		ln -sv $PREFIX_FINAL$x $CLFS$x 2>/dev/null
	    done
	    
	    echo done
	    ;;

	create-conf)
	    # this will handle config files for init, mdev, users/groups,
            # logfiles, login scripts, fstab, needed device nodes, etc
	    
	    # copy rcS and mdev.conf into etc
	    mkdir -vp $CLFS/etc/init.d &&
	    cp -v config/rcS $CLFS/etc/init.d &&
	    cp -v config/mdev.conf $CLFS/etc || exit 1

	    # copy passwd and group files into etc
	    cp -v config/{passwd,group} $CLFS/etc || exit 1
	    
	    # initialize login related log files.
	    #
	    # NOTE: busybox's init replacement might not use these, but if
	    #       switch over to the real sysvinit later on we'll want
	    #       these files
	    touch ${CLFS}/var/run/utmp ${CLFS}/var/log/{btmp,lastlog,wtmp} &&
	    chmod -v 664 ${CLFS}/var/run/utmp ${CLFS}/var/log/lastlog &&
	    chmod -v 600 ${CLFS}/var/log/btmp || exit 1
	    
	    # copy profile into root's homedir
	    cp -v config/profile $CLFS/root/.profile

	    # make sure these build variables are set
	    echo export BUILD32=\"$BUILD32\" >> $CLFS/root/.profile
	    echo export BUILD64=\"$BUILD64\" >> $CLFS/root/.profile
	    # FIXME: what about CLFS_HOST and CLFS_TARGET?  CLFS_TARGET is no
	    #        longer needed, probably the same for CLFS_HOST.  TARGET32
	    #        is still needed when we go to build 32bit libs.
	    echo export CLFS_TARGET32=\"$CLFS_TARGET32\" >> $CLFS/root/.profile
	    
            # generate fstab
            echo "# -*- mode: sh -*- " > $CLFS/etc/fstab
            if [ "$STAGE2_XEN" = "yes" ]; then
                echo "/dev/xvda1 / $CLFS_FSTYPE defaults 0 0" >> $CLFS/etc/fstab
            else
                echo "$CLFS_DEV / $CLFS_FSTYPE defaults 0 0" >> $CLFS/etc/fstab
            fi
            # FIXME: For right now, this needs to be rw, but we could possibly
            #        play with the idea of making it ro and passing it into
            #        multiple build domUs in parallel.
            #
            # NOTE: If configured, RUCKUS_DEV is passed in as the 2nd disk and
            #       mounted in /tmp/ruckus_dev.  /tmp/ruckus_dev/RUCKUS_PATH is
            #       then bind mounted to /ruckus.
            #
            # FIXME: Is there a performace penalty that could be avoided by
            #        mounting directly on /ruckus if RUCKUS_PATH == / ?
            if [ -n "$RUCKUS_DEV" ]; then
                mkdir -p $CLFS/ruckus $CLFS/tmp/ruckus_dev
                if [ "$STAGE2_XEN" = "yes" ]; then
                    echo "/dev/xvdb1 /tmp/ruckus_dev $RUCKUS_FSTYPE defaults 1 1" >> $CLFS/etc/fstab
                else
                    echo "$RUCKUS_DEV /tmp/ruckus_dev $RUCKUS_FSTYPE defaults 1 1" >> $CLFS/etc/fstab
                fi
                echo "/tmp/ruckus_dev /ruckus none bind 1 1" >> $CLFS/etc/fstab
            fi
            cat config/fstab >> $CLFS/etc/fstab || exit 1

	    # NOTE: now touch /.ruckus_bootstrap_stage2, which causes init
	    #       to run the stage2 script on tty1 at boot
            if [ "$STAGE2_AUTO" = "yes" ]; then
	        touch $CLFS$RUCKUS_BOOTSTRAP_STAGE2_FILE || exit 1
            fi

	    ;;

	kernel)
            # FIXME: I should redo the kernel configs, perhaps using ruckusrd
            #        for initramfs...
            #
            #        Don't forget, this is the cross-compiled bare-bones kernel
            #        just to get us booted up...  if we can live w/out modules,
            #        that would be great.  That being said, it would be nice to
            #        be kinda distro-kernel-ish so that most people with most
            #        hardware can just use our bootstrap config... we'll see.

	    setup_generic $1 || exit 1

	    if [ -n "$BUILD64" ]; then
		kernel_config=kernel-config-64bit
	    else
		kernel_config=kernel-config-32bit
	    fi

	    # get ready
	    MAKE="make KBUILD_SRC=$source -f $source/Makefile"
	    MAKE+=" ARCH=$CLFS_ARCH CROSS_COMPILE=$CLFS_TARGET-"
	    pushd $builddir &&
	    $MAKE mrproper &&
	    popd || exit 1

	    # get set
	    cp -v config/$kernel_config $builddir/.config &&
	    pushd $builddir &&
	    $MAKE oldconfig &&
	    popd || exit 1

	    # NOTE: if you want to do a make menuconfig to tweak .config,
	    #       NCURSES_PREFIX has to be set to $PREFIX_FINAL.

	    # go!
	    pushd $builddir &&
	    $MAKE -j$JOBCOUNT_KBUILD &&
            $MAKE INSTALL_MOD_PATH=${CLFS} modules_install &&
	    popd || exit 1

            # FIXME: CLFS does a make firmware_install... but that doesn't seem
            #        to be needed.  modules_install is installing the firmware
            #        already.
            #
            #$MAKE INSTALL_FW_PATH=${CLFS}/lib/firmware firmware_install

            # FIXME: Do we need to run depmod -b $CLFS?  Looks like
            #        modules_install does it at the end...

            # FIXME: Let's try and use the same kernel config, but just sed
            #        LOCALVERSION into it.  Then, after we've booted (and
            #        automagically loaded needed modules), remove
            #        lib/{modules,firmware}

            # FIXME: chowning everything to root is following the build and
            #        source symlinks into my source tree... obviously don't
            #        want that... but where should these symlinks really point
            #        to on the booted system?
            rm -f $CLFS/lib/modules/*/{build,source} || exit 1

	    # now actually install the resulting kernel files
	    pushd $builddir &&
	    cp -v arch/$CLFS_ARCH/boot/bzImage \
                $CLFS/boot/vmlinuz-ruckus-bootstrap &&
	    cp -v System.map $CLFS/boot/System.map-ruckus-bootstrap &&
	    cp -v .config $CLFS/boot/config-ruckus-bootstrap &&
	    popd || exit 1
	    ;;

        xen)
	    # NOTE: Just build the hypervisor.  This step is generally just
	    #       done to augment the bootstrap-early xen build on 32bit
	    #       systems with a cross-compiled 64bit hypervisor.
	    #
            # NOTE: Xen can't build out-of-tree, because of it's strange
            #       half-breed autotools build system.
	    build_in_tree=1 setup_generic $1 || exit 1

            # NOTE: It also needs to be explicitly configured (i.e., Makefile
            #       already exists).
            #
            # NOTE: We disable building tools, kernels, docs, and stubdom for
            #       stage1.
	    autoreconf=yes \
	        configure_generic $1 --prefix=$PREFIX_EARLY \
		--disable-tools \
		--disable-kernels --disable-docs --disable-stubdom || exit 1

	    # NOTE: The dist target should just be building the hypervisor, as
	    #       per our configure args above.
	    #
	    # NOTE: We set DESTDIR to install into $PREFIX_EARLY/boot.
	    MAKE="make"
	    MAKE+=" XEN_TARGET_ARCH=$CLFS_ARCH CROSS_COMPILE=$CLFS_TARGET-"
	    pushd $builddir &&
	    $MAKE -j$JOBCOUNT dist &&
            $MAKE DESTDIR=$PREFIX_EARLY install &&
	    popd || exit 1
	    ;;

	*)
	    build_generic $1 $OPTS || exit 1
	    ;;
    esac
}


packages=""
packages+=" gmp"
packages+=" mpfr"
packages+=" mpc"
packages+=" isl"
packages+=" cloog"
packages+=" zlib"
packages+=" binutils"
packages+=" gcc"
packages+=" ncurses"

# FIXME: what about the ncurses patch...?
packages+=" busybox"

# NOTE: The following CLFS /tools packages are replaced by our busybox
#       package's equivilent tools
#
#packages+=" bash"
#packages+=" bzip2"
#packages+=" coreutils"
#packages+=" diffutils"
#packages+=" findutils" # still missing locate...? do i care?
#packages+=" gawk"
#packages+=" grep"
#packages+=" gzip"
#packages+=" patch"
#packages+=" sed"
#packages+=" tar"
#packages+=" vim"
#packages+=" xz-utils"
#
# NOTE: The busybox xz applet(s) only support decompressing... If we need to
#       compress with xz from the bootstrap system, we'll need to install the
#       real xz package.  However, this does mean we're perfectly capable of
#       untarring tar.xz files transparently using busybox.
#
# FIXME: is that still true?

packages+=" bison"

packages+=" file"
packages+=" flex"

packages+=" gettext"

packages+=" m4"
packages+=" make"

packages+=" texinfo"

# boot prep
#
# FIXME: hmm... not sure how i'm gonna do this...  CLFS builds a bunch of
#        basic utils, udev, and a stripped down kernel in the target
#        filesystem (ie, not /tools) to make a bootable system.  Then
#        the next chapter in CLFS overwrites the installed files with the
#        final versions.  I guess this is doable...  The final system
#        packages are going to be packaged and installed with SRP, so we'll
#        have backup files all over the place that need to be remove.
#        Additionally, it would be nice if we could guarantee that there are
#        no bootstrap files left over.  Not sure how important that is,
#        though.
#
# NOTE: The following CLFS /tools packages (for booting) are currently
#       replaced by our busybox package... but we might want to actually
#       install the real versions.  util-linux-ng, for example, installs
#       pkg-config files that are searched for when building udev and/or hal
#       later on...  util-linux also provides us with crypto arguments for
#       losetup and mount.
#
#packages+=" sysvinit"
#packages+=" module-init-tools"  # kmod now?
#packages+=" udev"

packages+=" create-dirs"

# NOTE: create-symlinks requires .build/busybox/busybox.links...
packages+=" create-symlinks"

# more boot packages
#
# FIXME: am i building util-linux or using busybox applets?  i might want
#        cryptoloop and i might want -o remount.  transparent -o loop might
#        have diff behavior.
#
#packages+=" util-linux" # for transparent cryptoloop mounting?
#packages+=" e2fsprogs" # for bulletproof ext2/3/4 support

# NOTE: We want this to be a pretty usable tiny bootstrap system, so we're
#       gonna include propper NTFS support here as well.  Now we'll have
#       support for ext2/3/4, vfat, and ntfs filesystems along with
#       losetup/mount support for the kernel's cryptoloop code.
#
# FIXME: actually, the cryptoloop stuff in the latest util-linux is broken.
#        it's been deprecated for years in favor of dm-crypt, so i doubt it's
#        going to be fixed...  if the transparent cryptoloop mount usage was
#        the only reason i went with the real util-linux here, i should
#        reconsider.
#packages+=" ntfs-3g"

# FIXME: mdev vs udev.  I suspect that if we base our desktop image on our
#        embedded image, parts of the desktop (GNOME, KDE, etc) are going to
#        require udev.  Modern versions of udev, however, don't appear to
#        play well with busybox's (or e2fsprogs') versions of blkid and
#        libuuid.  So, our final system might want to use util-linux-ng and
#        udev instead of busybox's mdev setup.  Not really sure how best to
#        handle this yet.  Anyway, it's probably simpler for our bootable
#        bootstrap system to just use busybox's mdev for now.
#packages+=" udev"

# this will handle config files for init, mdev, users/groups, logfiles,
# login scripts, fstab, needed device nodes, etc
packages+=" create-conf"

packages+=" kernel"



# If we have STAGE1_XEN_ONLY set, replace the entire pacakges list with just
# xen.  Otherwise, if we're building for 64bit, but building on 32bit, and
# want to use Xen for stage2, we need to cross-compile the hypervisor here in
# addition to the other packages.
if [ "$STAGE1_XEN_ONLY" = "yes" ]; then
    packages=xen
elif [ "$XEN_ENABLED" = "yes" ]; then
    packages+=" xen"
fi


mkdir -p $PWD/.build

# now iterate through building for our target architecture using our
# cross-compiler.
for p in $packages; do
    echo -e "\n+++++ building bootstrap-stage1 package: $p"
    build $p || exit 1
done

# make a backup of our progress.
#
# FIXME: perhaps i should ditch the compression on these backups?  it's adding
#        about 10 minutes to the build time and compressed 890M down to about
#        180M on a 64bit-multilib build.  using bzip only took 2.5 minutes and
#        resulted in a 290M archive.  piping tar into xz -0 took 1.5 minutes
#        and resulted in a 240M file.
#
if [ "$STAGE1_XEN_ONLY" != "yes" ]; then
    echo -n "creating bootstrap-stage1 backup... "
    mkdir -p $BUILDROOT &&
    tar -c \
        --exclude ./ruckus --exclude ./lost+found \
        -C $CLFS . \
        | xz -0 > $BUILDROOT/baby-bootstrap-stage1.tar.xz || exit 1
    echo "done."
fi



# FIXME: Everything below this needs to be done as root (except the backup).
#        Move the backup up here and run it non-root, then split the reset of
#        this (along with the silly fix-perms "package" into a seperate script
#        for the user to run as root.  This final script should groom/install
#        everyting onto some type of media so that the user can go boot it up
#        to kick off stage2!  Woo!
exit 0

