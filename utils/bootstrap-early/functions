# -*- mode: sh -*-

packagedir=$toplevel/packages

INSTALLROOT=$HOME/RUCKUS
PREFIX_EARLY=$INSTALLROOT/bootstrap-early
PREFIX_CROSS=/bootstrap-cross

# this is where our baby filesystem will eventually be mounted
BABY=$INSTALLROOT/baby

# FIXME: should think about defining a variable for $BABY/bootstrap.  the
#        /bootstrap moniker is hardcoded into a bunch of source files (into
#        patches actually), so this might be non-trivial
PREFIX_FINAL=/bootstrap

# setup environment to use our bootstrap-early stuff
export PATH=$PREFIX_EARLY/bin:$PREFIX_EARLY/sbin:$PATH
export MANPATH=$PREFIX_EARLY/man:$PREFIX_EARLY/share/man:$MANPATH
export PKG_CONFIG_PATH=$PREFIX_EARLY/lib/pkg-config:$PKG_CONFIG_PATH
if [ -z "$LD_LIBRARY_PATH" ]; then
    export LD_LIBRARY_PATH=$PREFIX_EARLY/lib
else
    export LD_LIBRARY_PATH=$PREFIX_EARLY/lib:$LD_LIBRARY_PATH
fi

# and now add in the bootstrap-cross tools
export PATH=$PREFIX_CROSS/bin:$PREFIX_CROSS/sbin:$PATH
export MANPATH=$PREFIX_CROSS/man:$PREFIX_CROSS/share/man:$MANPATH
export PKG_CONFIG_PATH=$PREFIX_CROSS/lib/pkg-config:$PKG_CONFIG_PATH
if [ -z "$LD_LIBRARY_PATH" ]; then
    export LD_LIBRARY_PATH=$PREFIX_CROSS/lib
else
    export LD_LIBRARY_PATH=$PREFIX_CROSS/lib:$LD_LIBRARY_PATH
fi


# set host and target variables.  this should eventually be done via autoconf

# NOTE: MACHTYPE on a fedora 32bit box is 'i386-redhat-linux-gnu', but on a SUSE box it's just 'i686'
#export CLFS_HOST="$(echo ${MACHTYPE} | \
#    sed "s/$(echo ${MACHTYPE} | cut -d- -f2)/cross/")"

export MACHTYPE_HOST="i686-cross-linux-gnu"

export MACHTYPE_TARGET="x86_64-ruckus-linux-gnu"

export MACHTYPE_TARGET32="i686-ruckus-linux-gnu"

# these should also get determined by autoconf
export ARCH_TARGET=x86_64

# these variables seem like overkill, but might make things easier later on.
# they should probably also be set vi autoconf
export BUILD32="-m32"
export BUILD64="-m64"


# define generic builder method.  this does some magic to set up a build
# tree based on what's stored in packagedir (ie, a source tree or a source
# tarball).  first arg is package name, the rest are passed on to configure.
build_generic()
{
    setup_generic $*
    configure_generic $*
    compile_generic $*
}


setup_generic()
{
    p=$1
    shift
    builddir=$PWD/.build/$p
    sourcedir=$packagedir/$p
    configure=$sourcedir/configure
    mkdir -p $builddir

    # figure out if we're using a source tarball or an already unpacked
    # source tree.  we do this by looking for configure, configure.ac, or
    # configure.in in the packagedir
    if [ ! -x $configure ] && [ ! -f $configure.ac ] && [ ! -f $configure.in ]; then
	echo "using source tarball"
	# using tarball.  need to modify some variables and extract the
	# source tree
	pushd $builddir
	echo checking for previously extracted source tree...
	if ! $(cd ./$p*); then
	    echo extracting...
	    tar jxf $packagedir/$p/*.tar.bz2 || exit 1
	fi
	pushd ./$p* &&
	sourcedir=$PWD &&
	configure=$sourcedir/configure &&
	popd &&
	builddir=$builddir/build &&
	mkdir -p $builddir || exit 1
	popd
	# also apply any patches in the packagedir
	pushd $sourcedir
	# only do this if we haven't previously configured
	if [ ! -f $builddir/Makefile ]; then
	    if [ -f $packagedir/$p/*.patch ]; then
		for p in $packagedir/$p/*.patch; do
		    patch -Np1 < $p || exit 1
		done
	    fi
	fi
	popd
    fi
    echo sourcedir: $sourcedir
    echo builddir:  $builddir
    echo configure: $configure
}


configure_generic()
{
    p=$1
    shift
    #builddir=.build/$p
    #configure=$packagedir/$p/configure
    #mkdir -p $builddir

    # go guild it!
    pushd $builddir || exit 1
    # only explicitly run configure the first time
    if [ ! -f Makefile ]; then
	# only explicitly run autoreconf the first time
	if [ ! -x $configure ]; then
	    pushd $(dirname $configure)
	    autoreconf || exit 1
	    popd
	fi
	$configure $* || exit 1
    fi
    popd
}


compile_generic()
{
    p=$1
    shift
    #builddir=.build/$p
    #configure=$packagedir/$p/configure
    #mkdir -p $builddir

    pushd $builddir &&
    make -j3 && make install &&
    popd || exit 1
}
