#!/bin/bash

# should set toplevel via autoconf?
toplevel=$PWD/../..

# source our common variables and functions
. $toplevel/utils/bootstrap-early/functions


# install linux headers
build_linux_headers()
{
    builddir=.build/kernel
    # get the source tree into our build dir
    rsync -a --exclude .git $packagedir/kernel/ $builddir || exit 1
    pushd $builddir
    make mrproper &&
    make ARCH=$ARCH_TARGET headers_check &&
    make ARCH=$ARCH_TARGET INSTALL_HDR_PATH=dest headers_install || exit 1

    # FIXME: CLFS book used /tools as apposed to /cross-tools here... not
    #        sure why.  it might just be that this is really a
    #        bootstrap-final chore that needs to be done prior to building
    #        bootstrap-cross...  need to investigate later.
    mkdir -p $BABY$PREFIX_FINAL/include &&
    rsync -v dest/include/* $BABY$PREFIX_FINAL/include || exit 1
    popd
}



build()
{
    case "$1" in
	linux_headers)
	    build_linux_headers
	    ;;
	ncurses)
	    # probably only need to make the tic program, but this is
	    # easier.  might save us 10M and 1 minute, but it's all
	    # temporary files anyway so we don't really care very much about
	    # the 10M
	    build_generic $1 --prefix=$PREFIX_CROSS --without-debug --without-shared
	    ;;
	gmp)
	    CPPFLAGS=-fexceptions \
		build_generic $1 --prefix=$PREFIX_CROSS --enable-cxx
	    ;;
	mpfr)
	    LDFLAGS="-Wl,-rpath,$PREFIX_CROSS/lib" \
		build_generic $1 --prefix=$PREFIX_CROSS \
		--enable-shared \
		--with-gmp=$PREFIX_CROSS
	    ;;
	mpc)
	    LDFLAGS="-Wl,-rpath,$PREFIX_CROSS/lib" \
		build_generic $1 --prefix=$PREFIX_CROSS \
		--with-gmp=$PREFIX_CROSS \
		--with-mpfr=$PREFIX_CROSS
	    ;;
	ppl)
	    LDFLAGS="-Wl,-rpath,$PREFIX_CROSS/lib" \
		build_generic $1 --prefix=$PREFIX_CROSS \
		--enable-shared \
		--enable-interfaces="c,cxx" \
		--disable-optimization \
		--with-libgmp-prefix=$PREFIX_CROSS \
		--with-libgmpxx-prefix=$PREFIX_CROSS
	    ;;
	cloog-ppl)
	    LDFLAGS="-Wl,-rpath,$PREFIX_CROSS/lib" \
		build_generic $1 --prefix=$PREFIX_CROSS \
		--enable-shared \
		--with-bits=gmp \
		--with-gmp=$PREFIX_CROSS \
		--with-ppl=$PREFIX_CROSS
	    ;;
	binutils)
	    # this was using /tools as apposed to /tools-cross in the CLFS
	    # book
	    AR=ar AS=as setup_generic $1 &&
	    AR=ar AS=as \
		configure_generic $1 --prefix=$PREFIX_CROSS \
		--host=${MACHTYPE_HOST} \
		--target=${MACHTYPE_TARGET} \
		--with-sysroot=${INSTALLROOT} \
		--with-lib-path=$BABY$PREFIX_FINAL/lib \
		--disable-nls \
		--enable-shared \
		--enable-64-bit-bfd || exit 1
	    pushd $builddir || exit 1
	    make configure-host &&
	    make -j3 &&
	    make install || exit 1

	    # copy libiberty.h to $PREFIX_FINAL/include directory
	    #
	    # FIXME: not sure why the CLFS book used /tools instead of
	    #        /cross-tools here... should look into it later on.
	    #
	    # FIXME: the CLFS book was also building this in a
	    #        binutils-build dir, which we're not.  should look into
	    #        adding code to figure out dynamically if we're doing an
	    #        out-of-tree build and get the right path here, because
	    #        we *could* be doing an out-of-tree build if
	    #        $toplevel/packages/$1 is a git submodule.
	    mkdir -p $BABY$PREFIX_FINAL/include &&
	    cp -v include/libiberty.h $BABY$PREFIX_FINAL/include || exit 1
	    popd
	    ;;
	gcc-static)
	    setup_generic gcc &&
	    pushd $builddir || exit 1
	    for p in $toplevel/utils/bootstrap-cross/patches/gcc/*.patch; do
		patch -Np1 < $p || exit 1
	    done
	    popd

	    # create a dummy limits.h so the build will not use the one
	    # provided by the host distro
	    mkdir -p $BABY$PREFIX_FINAL/include &&
	    touch $BABY$PREFIX_FINAL/include/limits.h || exit 1

	    AR=ar LDFLAGS="-Wl,-rpath,$PREFIX_CROSS/lib" \
		configure_generic gcc --prefix=$PREFIX_CROSS \
		--build=${MACHTYPE_HOST} \
		--host=${MACHTYPE_HOST} \
		--target=${MACHTYPE_TARGET} \
		--with-sysroot=${INSTALLROOT} \
		--with-local-prefix=$BABY$PREFIX_FINAL/lib \
		--disable-nls \
		--disable-shared \
		--with-mpfr=$PREFIX_CROSS \
		--with-gmp=$PREFIX_CROSS \
		--with-ppl=$PREFIX_CROSS \
		--with-cloog=$PREFIX_CROSS \
		--without-headers \
		--with-newlib \
		--disable-decimal-float \
		--disable-libgomp \
		--disable-libmudflap \
		--disable-libssp \
		--disable-threads \
		--enable-languages=c || exit 1

	    pushd $builddir || exit 1
	    make -j3 all-gcc all-target-libgcc &&
	    make install-gcc install-target-libgcc || exit 1
	    popd
	    ;;
	*)
	    build_generic $1 --prefix=$PREFIX_CROSS
	    ;;
    esac
}


packages=""
#packages+=" linux_headers"
#packages+=" file"
#packages+=" ncurses"
#packages+=" gmp"
#packages+=" mpfr"
#packages+=" mpc"
#packages+=" ppl"
#packages+=" cloog-ppl"
#packages+=" binutils"
packages+=" gcc-static"
#packages+=" eglibc-32bit"
#packages+=" eglibc-64bit"
#packages+=" gcc"

for p in $packages; do
    echo "building cross package: $p"
    build $p || exit 1
done
