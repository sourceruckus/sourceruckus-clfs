#!/bin/sh
#
# FIXME: Where should I execute this...?  If I put it in a notes file (either
#        glibc or a simple hello-world package), it will be modifying the host
#        system during installation... which I'd really like to be able to
#        swear off as BAD.
#
#        I think I'm going to wrap this up with the multiarch_wrapper, one way
#        or another.  We'll make that package:
#
#         1. (MAYBE) run this script to adjust the toolchain, if needed
#         2. compile/install the multiarch_wrapper
#         3. install my foo.c as /usr/share/multiarch_wrapper/test.c
#         4. compile/install multiarch_wrapper_test{32,64} in /usr/bin
#         5. create multiarch_wrapper_test symlink in /usr/bin
#         6. ensure test32 is using /lib/ld-linux.so.2
#         7. ensure test64 is using /lib64/ld-linux-x86-64.so
#
#         8. ensure USE_ARCH=32 and USE_ARCH=64 execute the correct version of
#            the multiarch_wrapper_test.


# snag srp's functions
. /tools*/share/srp/functions || exit 1


# prep ########################################################################

# detect exact /tools* path
#
# NOTE: For CLFS, this is always /tools, but we append the arch string to that
#       dir so that we can build multiple bootstrap environments in parallel.
#
pushd /tools* &&
TOOLS=$PWD &&
popd || exit 1
echo TOOLS: $TOOLS

# NOTE: I added the $TOOLS expansion and the extra libx32 replacement.  The
#       CLFS book leaves out the lib64 replacement unless building x86_64
#       multilib and doesn't do anything with libx32 (even though the version
#       of glibc DOES list it as valid).
#
gcc -dumpspecs |  perl -p \
    -e "s@$TOOLS/lib/ld@/lib/ld@g;" \
    -e "s@$TOOLS/lib64/ld@/lib64/ld@g;" \
    -e "s@$TOOLS/libx32/ld@/libx32/ld@g;" \
    -e "s@\*startfile_prefix_spec:\n@\$_/usr/lib/ @g;" \
    > $(dirname $(gcc --print-libgcc-file-name))/specs
